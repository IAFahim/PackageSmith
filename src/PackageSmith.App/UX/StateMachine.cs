using System;
using Spectre.Console;
using PackageSmith.App.Bridges;
using PackageSmith.Data.State;
using PackageSmith.Data.Types;
using PackageSmith.Core.Logic;

namespace PackageSmith.App.UX;

public static class StateMachine
{
	public static int Run()
	{
		while (true)
		{
			AnsiConsole.Clear();
			ShowMenu();

			var choice = AnsiConsole.Prompt(
				new SelectionPrompt<string>()
					.Title("[steelblue]Select an option:[/]")
					.AddChoices(new[] { "New Package", "Settings", "Exit" }));

			switch (choice)
			{
				case "New Package": NewPackageFlow(); break;
				case "Settings": SettingsFlow(); break;
				case "Exit": return 0;
			}
		}
	}

	private static void ShowMenu()
	{
		AnsiConsole.Write(new Panel(new FigletText("PkSmith").Color(Color.SteelBlue))
			.Border(BoxBorder.Double).Expand());
	}

	private static void NewPackageFlow()
	{
		AnsiConsole.MarkupLine("[steelblue]Create New Package[/]");

		var name = AnsiConsole.Ask<string>("Package Name (e.g. [green]com.studio.tool[/]):");
		var parts = name.Split('.');
		var display = AnsiConsole.Ask<string>("Display Name:", parts.Length > 0 ? parts[^1] : name);

		var template = AnsiConsole.Prompt(
			new SelectionPrompt<TemplateType>()
				.Title("Select Template")
				.AddChoices(TemplateType.None, TemplateType.MonoBehaviour, TemplateType.EcsFull));

		var package = new PackageState
		{
			PackageName = name,
			DisplayName = display,
			Description = "Generated by PackageSmith",
			OutputPath = Environment.CurrentDirectory,
			SelectedTemplate = template,
			EcsPreset = new EcsPresetState { EnableEntities = template == TemplateType.EcsFull },
			SelectedModules = PackageModuleType.Runtime | PackageModuleType.Editor
		};

		var bridge = new PackageBridge();
		if (bridge.TryCreate(in package))
		{
			PackageLogic.CombinePath(package.OutputPath, package.PackageName, out var fullPath);
			GitLogic.TryInitGit(fullPath, out var gitInit);

			AnsiConsole.MarkupLine(gitInit
				? "[green]Initialized git repository.[/]"
				: "[yellow]Skipped git init.[/]");

			AnsiConsole.MarkupLine("\n[green bold]Done![/] Press Enter.");
			Console.ReadLine();
		}
	}

	private static void SettingsFlow()
	{
		var bridge = new ConfigBridge();
		var config = bridge.TryLoad(out var c) ? c : bridge.GetDefault();

		AnsiConsole.MarkupLine($"Current Author: [green]{config.CompanyName}[/]");
		if (AnsiConsole.Confirm("Update Settings?"))
		{
			var newCompany = AnsiConsole.Ask("Company Name:", config.CompanyName);
			config.CompanyName = newCompany;
			bridge.TrySave(in config);
		}
	}
}
